<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turbine Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #fff; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #4CAF50; font-size: 2.5em; margin-bottom: 10px; }
        .status { display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: bold; }
        .status.connected { background: #4CAF50; }
        .status.disconnected { background: #f44336; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .card { background: #2d2d2d; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card h3 { color: #4CAF50; margin-bottom: 15px; font-size: 1.3em; }
        
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .metric { background: #3d3d3d; padding: 15px; border-radius: 8px; text-align: center; }
        .metric-value { font-size: 2em; font-weight: bold; color: #4CAF50; }
        .metric-label { color: #ccc; margin-top: 5px; }
        
        .logs { height: 400px; overflow-y: auto; background: #1e1e1e; border-radius: 8px; padding: 15px; }
        .log-entry { margin-bottom: 8px; font-family: 'Courier New', monospace; font-size: 0.9em; }
        .log-timestamp { color: #888; }
        .log-rx { color: #4CAF50; }
        .log-tx { color: #2196F3; }
        .log-data { color: #fff; }
        
        .full-width { grid-column: 1 / -1; }
        #debugToggle, #serialToggle { background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        #debugToggle:hover, #serialToggle:hover { background: #45a049; }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .metrics { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå™Ô∏è Wind Turbine Monitor</h1>
            <div id="status" class="status disconnected">Disconnected</div>
            <div id="lastUpdate" style="margin-top: 10px; color: #ccc;"></div>
            <div style="margin-top: 15px;">
                <button onclick="sendCommand('start')" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 0 5px;">Start</button>
                <button onclick="sendCommand('stop')" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 0 5px;">Stop</button>
                <button onclick="sendCommand('reset')" style="background: #FF9800; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 0 5px;">Reset</button>
                <button onclick="sendCommand('manual_start')" style="background: #9C27B0; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 0 5px;">Manual Start</button>
            </div>
            <button id="mainDebugToggle" onclick="toggleDebugWindow()" style="margin-top: 10px; background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">Show Debug</button>
        </div>
        
        <div class="grid">
            <div class="card">
                <h3>üìä Live Data</h3>
                <div class="metrics">
                    <div class="metric">
                        <div id="windSpeed" class="metric-value">--</div>
                        <div class="metric-label">Wind Speed (m/s)</div>
                    </div>
                    <div class="metric">
                        <div id="power" class="metric-value">--</div>
                        <div class="metric-label">Power (W)</div>
                    </div>
                    <div class="metric">
                        <div id="rotorRpm" class="metric-value">--</div>
                        <div class="metric-label">Rotor RPM</div>
                    </div>
                    <div class="metric">
                        <div id="genRpm" class="metric-value">--</div>
                        <div class="metric-label">Generator RPM</div>
                    </div>
                    <div class="metric">
                        <div id="l1v" class="metric-value">--</div>
                        <div class="metric-label">L1 Voltage (V)</div>
                    </div>
                    <div class="metric">
                        <div id="l2v" class="metric-value">--</div>
                        <div class="metric-label">L2 Voltage (V)</div>
                    </div>
                    <div class="metric">
                        <div id="l3v" class="metric-value">--</div>
                        <div class="metric-label">L3 Voltage (V)</div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #3d3d3d; border-radius: 8px;">
                    <strong>Status:</strong> <span id="statusMessage">--</span><br>
                    <strong>Event Stack:</strong> <span id="eventStack2">--</span> | <span id="eventStack1">--</span> | <span id="eventStack0">--</span><br>
                    <strong>Controller Time:</strong> <span id="controllerTime">--</span><br>
                    <strong>Time Offset:</strong> <span id="timeOffset">--</span>
                </div>
            </div>
            
            <div class="card">
                <h3>üìà 1-Minute Averages</h3>
                <div class="metrics">
                    <div class="metric">
                        <div id="power1min" class="metric-value">--</div>
                        <div class="metric-label">Power (W)</div>
                    </div>
                    <div class="metric">
                        <div id="l1v1min" class="metric-value">--</div>
                        <div class="metric-label">L1 Voltage (V)</div>
                    </div>
                    <div class="metric">
                        <div id="l2v1min" class="metric-value">--</div>
                        <div class="metric-label">L2 Voltage (V)</div>
                    </div>
                    <div class="metric">
                        <div id="l3v1min" class="metric-value">--</div>
                        <div class="metric-label">L3 Voltage (V)</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>üì° MQTT Traffic</h3>
                <div id="mqttLogs" class="logs"></div>
            </div>
        </div>
        
        <div class="card full-width" id="serialCard">
            <h3>üîå Serial Communication <button id="serialToggle" onclick="toggleSerial()">Hide</button></h3>
            <div id="serialLogs" class="logs"></div>
        </div>
        
        <div class="card full-width" id="debugCard" style="display: none;">
            <h3>üêõ Debug Responses <button id="debugToggle" onclick="toggleDebug()">Hide</button></h3>
            <div id="debugLogs" class="logs"></div>
        </div>
    </div>

    <script>
        const socket = io();
        
        socket.on('connect', function() {
            console.log('Connected to server');
        });
        
        socket.on('status', function(data) {
            const statusEl = document.getElementById('status');
            const lastUpdateEl = document.getElementById('lastUpdate');
            
            if (data.connected) {
                statusEl.textContent = 'Connected';
                statusEl.className = 'status connected';
            } else {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'status disconnected';
            }
            
            if (data.last_update) {
                const date = new Date(data.last_update);
                lastUpdateEl.textContent = `Last update: ${date.toLocaleString()}`;
            }
        });
        
        socket.on('data', function(data) {
            document.getElementById('windSpeed').textContent = data.wind_speed_mps?.toFixed(1) || '--';
            document.getElementById('power').textContent = data.power_W?.toFixed(0) || '--';
            document.getElementById('rotorRpm').textContent = data.rotor_rpm?.toFixed(0) || '--';
            document.getElementById('genRpm').textContent = data.generator_rpm?.toFixed(0) || '--';
            document.getElementById('l1v').textContent = data.l1v?.toFixed(0) || '--';
            document.getElementById('l2v').textContent = data.l2v?.toFixed(0) || '--';
            document.getElementById('l3v').textContent = data.l3v?.toFixed(0) || '--';
            document.getElementById('statusMessage').textContent = data.status_message || '--';
            document.getElementById('eventStack2').textContent = data.event_stack_2 || '--';
            document.getElementById('eventStack1').textContent = data.event_stack_1 || '--';
            document.getElementById('eventStack0').textContent = data.event_stack_0 || '--';
            document.getElementById('controllerTime').textContent = data.controller_time || '--';
            document.getElementById('timeOffset').textContent = data.time_offset || '--';
            
            // 1-minute averages
            document.getElementById('power1min').textContent = data.power_W_1min?.toFixed(0) || '--';
            document.getElementById('l1v1min').textContent = data.l1v_1min?.toFixed(0) || '--';
            document.getElementById('l2v1min').textContent = data.l2v_1min?.toFixed(0) || '--';
            document.getElementById('l3v1min').textContent = data.l3v_1min?.toFixed(0) || '--';
        });
        
        socket.on('mqtt_log', function(entry) {
            addLogEntry('mqttLogs', entry, entry.direction === 'RX' ? 'log-rx' : 'log-tx');
        });
        
        socket.on('serial_log', function(entry) {
            if (serialEnabled) {
                addLogEntry('serialLogs', entry, 'log-data');
            }
        });
        
        socket.on('debug_response', function(entry) {
            addDebugEntry(entry);
        });
        
        let debugEnabled = false;
        let serialEnabled = true;
        
        function toggleDebugWindow() {
            const debugCard = document.getElementById('debugCard');
            const toggleBtn = document.getElementById('mainDebugToggle');
            debugEnabled = !debugEnabled;
            
            if (debugEnabled) {
                debugCard.style.display = 'block';
                toggleBtn.textContent = 'Hide Debug';
            } else {
                debugCard.style.display = 'none';
                toggleBtn.textContent = 'Show Debug';
            }
        }
        
        function toggleDebug() {
            toggleDebugWindow();
        }
        
        function toggleSerial() {
            const serialLogs = document.getElementById('serialLogs');
            const toggleBtn = document.getElementById('serialToggle');
            serialEnabled = !serialEnabled;
            
            if (serialEnabled) {
                serialLogs.style.display = 'block';
                toggleBtn.textContent = 'Hide';
            } else {
                serialLogs.style.display = 'none';
                toggleBtn.textContent = 'Show';
            }
        }
        
        function addLogEntry(containerId, entry, className) {
            const container = document.getElementById(containerId);
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date(entry.timestamp).toLocaleTimeString();
            const content = entry.payload || entry.data || '';
            const topic = entry.topic ? ` [${entry.topic}]` : '';
            const direction = entry.direction ? `[${entry.direction}]` : '';
            
            logEntry.innerHTML = `
                <span class="log-timestamp">${timestamp}</span>
                <span class="${className}">${direction}${topic}</span>
                <span class="log-data">${content}</span>
            `;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            // Keep only last 100 entries
            while (container.children.length > 100) {
                container.removeChild(container.firstChild);
            }
        }
        
        function addDebugEntry(entry) {
            if (!debugEnabled) return;
            
            const container = document.getElementById('debugLogs');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date(entry.timestamp).toLocaleTimeString();
            const content = `REQ[${entry.request_data_id}:${entry.request_sub_id}] -> RSP[${entry.response_mainid}:${entry.response_subid}] = ${entry.value} (type:${entry.data_type})`;
            
            logEntry.innerHTML = `
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-data">${content}</span>
            `;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            // Keep only last 100 entries
            while (container.children.length > 100) {
                container.removeChild(container.firstChild);
            }
        }
        
        function sendCommand(command) {
            socket.emit('command', command);
        }
    </script>
</body>
</html>